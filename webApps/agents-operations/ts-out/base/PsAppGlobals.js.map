{"version":3,"file":"PsAppGlobals.js","sourceRoot":"","sources":["../../src/base/PsAppGlobals.ts"],"names":[],"mappings":"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","sourcesContent":["\nimport { YpAppGlobals } from '@yrpri/webapp/yp-app/YpAppGlobals.js';\nimport { PsServerApi } from './PsServerApi.js';\n\nexport class PsAppGlobals extends YpAppGlobals {\n  originalQueryParameters: any;\n  originalReferrer: string;\n  questionId: number;\n  earlId: number;\n  promptId: number;\n  earlName: string;\n  disableParentConstruction = true;\n  exernalGoalParamsWhiteList: string | undefined;\n\n  agentsInstanceRegistry: Map<number, PsAgentAttributes> = new Map();\n  connectorsInstanceRegistry: Map<number, PsAgentConnectorAttributes> = new Map();\n\n  currentRunningAgentId: number | undefined;\n  currentAgentListeners: any[] = [];\n\n  constructor(serverApi: PsServerApi) {\n    super(serverApi, true);\n    this.currentRunningAgentId = undefined;\n    this.parseQueryString();\n    //this.earlName = this.getEarlName();\n    this.originalReferrer = document.referrer;\n    document.addEventListener('set-ids' as any, this.setIds.bind(this));\n  }\n\n  setCurrentRunningAgentId(id: number | undefined) {\n    this.currentRunningAgentId = id;\n    this.notifyCurrentAgentListeners();\n  }\n\n  addCurrentAgentListener(callback: Function) {\n    this.currentAgentListeners.push(callback);\n  }\n\n  removeCurrentAgentListener(callback: Function) {\n    this.currentAgentListeners = this.currentAgentListeners.filter(listener => listener !== callback);\n  }\n\n  notifyCurrentAgentListeners() {\n    this.currentAgentListeners.forEach(listener => listener(this.currentRunningAgentId));\n  }\n\n  addToAgentsRegistry = (agent: PsAgentAttributes): void => {\n    this.agentsInstanceRegistry.set(agent.id, agent);\n  }\n\n  addToConnectorsRegistry = (connector: PsAgentConnectorAttributes): void => {\n    this.connectorsInstanceRegistry.set(connector.id, connector);\n  }\n\n  getAgentInstance(agentId: number): PsAgentAttributes | undefined {\n    return this.agentsInstanceRegistry.get(agentId);\n  }\n\n  getConnectorInstance(connectorId: number): PsAgentConnectorAttributes | undefined {\n    return this.connectorsInstanceRegistry.get(connectorId);\n  }\n\n  getEarlName = (): string | null => {\n    const urlParams = new URLSearchParams(window.location.search);\n\n    if (urlParams.has('name')) {\n      return urlParams.get('name');\n    } else {\n      const pathSegments = window.location.pathname.split('/');\n      if (pathSegments.length >= 2 && pathSegments[1]) {\n        return pathSegments[1];\n      }\n    }\n\n    console.error(\n      `Earl name not found in URL or path: ${window.location.href}`\n    );\n    return null;\n  };\n\n  setIds = (e: CustomEvent): void => {\n    this.questionId = e.detail.questionId;\n    this.earlId = e.detail.earlId;\n    this.promptId = e.detail.promptId;\n  };\n\n  parseQueryString = (): void => {\n    const query = (window.location.search || '?').substr(1);\n    let map: { [key: string]: string } = {};\n\n    const re = /([^&=]+)=?([^&]*)(?:&+|$)/g;\n    let match;\n    while ((match = re.exec(query))) {\n      const key = match[1];\n      const value = match[2];\n      map[key] = value;\n    }\n\n    this.originalQueryParameters = map;\n  };\n\n  getSessionFromCookie = (): string => {\n    const strCookies = document.cookie;\n    const cookiearray = strCookies.split(';');\n    let sid = '';\n    for (let i = 0; i < cookiearray.length; i++) {\n      let name = cookiearray[i].split('=')[0];\n      let value = cookiearray[i].split('=')[1];\n      if (name.trim() === '_all_our_ideas_session') {\n        sid = value;\n      }\n    }\n    return sid;\n  };\n\n  getOriginalQueryString() {\n    if (this.originalQueryParameters) {\n      return new URLSearchParams(this.originalQueryParameters).toString();\n    } else {\n      return null;\n    }\n  }\n\n  activity = (type: string, object: any | undefined = undefined): void => {\n    let actor: string;\n\n    if (window.appUser && window.appUser.user) {\n      //actor = window.appUser.user.id;\n    } else {\n      actor = '-1';\n    }\n\n    const date = new Date();\n    const body = {\n      actor: actor,\n      type: type,\n      object: object,\n      path_name: location.pathname,\n      event_time: date.toISOString(),\n      session_id: this.getSessionFromCookie(),\n      originalQueryString: this.getOriginalQueryString(),\n      originalReferrer: this.originalReferrer,\n      questionId: this.questionId,\n      earlId: this.earlId,\n      promptId: this.promptId,\n      earlName: this.earlName,\n      userLocale: window.locale,\n      userAutoTranslate: window.autoTranslate,\n      user_agent: navigator.userAgent,\n      referrer: document.referrer,\n      url: location.href,\n      screen_width: window.innerWidth,\n    };\n\n    //@ts-ignore\n    if (typeof gtag == 'function') {\n      //@ts-ignore\n      gtag('event', type)\n    }\n\n    try {\n      fetch('/api/analytics/createActivityFromApp', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(body),\n      })\n        .then(response => {\n          if (!response.ok) {\n            console.error(`HTTP error! status: ${response.status}`);\n          } else {\n            if (\n              type === 'Voting - left' ||\n              type === 'Voting - right' ||\n              type === 'New Idea - added'\n            ) {\n              this.checkExternalGoalTrigger(type);\n            }\n          }\n        })\n        .catch(error => {\n          console.error(\n            'There has been a problem with your fetch operation:',\n            error\n          );\n        });\n    } catch (error) {\n      console.error(error);\n    }\n  };\n}\n"]}